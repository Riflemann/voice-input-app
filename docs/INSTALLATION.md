# Руководство по установке и автоматической настройке

## Обзор

Приложение voice-input-app теперь включает **полностью автоматическую настройку и установку моделей** при первом запуске. Пользователям больше не требуется вручную скачивать и настраивать модели Whisper или зависимости.

## Что устанавливается автоматически

### 1. Модели Whisper

- **Стандартная модель**: модель `base` (141 MB) автоматически загружается при первом запуске
- **Доступные модели**: пользователи могут вручную загрузить дополнительные модели (tiny, small, medium, large) из приложения
- **Место хранения**: 
  - Windows: `%AppData%/voice-input-app/whisper_models/ggml-base.bin`
  - macOS: `~/Library/Application Support/voice-input-app/whisper_models/ggml-base.bin`
  - Linux: `~/.config/voice-input-app/whisper_models/ggml-base.bin`
- **Что происходит при первом запуске**:
  1. Приложение проверяет наличие модели
  2. Если модель не найдена, приложение загружает её с HuggingFace
  3. Загрузка занимает 2-5 минут в зависимости от интернета
  4. После загрузки приложение готово к работе

### 2. Директория данных приложения
- Создается автоматически в папке AppData пользователя
- Содержит модели, кэш и файлы конфигурации
- Пути для разных платформ:
  - **Windows**: `C:\Users\{имя_пользователя}\AppData\Roaming\voice-input-app\`
  - **macOS**: `~/Library/Application Support/voice-input-app/`
  - **Linux**: `~/.config/voice-input-app/`

## Опыт использования при первом запуске

### Что видят пользователи

1. **Фаза установки**
   - Приложение запускается с экраном загрузки
   - Статус: "Инициализация приложения - Установка моделей Whisper для распознавания речи"
   - Индикатор прогресса показывает выполнение процесса
   - Ориентировочное время: 2-5 минут в зависимости от скорости интернета

2. **После установки**
   - Приложение автоматически запускается
   - Модель Whisper готова к использованию
   - Пользователь может сразу же начать записывать и транскрибировать

### Что происходит в фоне

1. Frontend вызывает Tauri команду `initialize_app()`
2. Backend:
   - Создает директорию моделей, если ее нет
   - Проверяет, установлена ли стандартная модель (base)
   - Загружает модель с HuggingFace, если необходимо
   - Проверяет целостность модели
3. Frontend получает статус завершения и отображает основной интерфейс

## Сборка и распространение

### Windows инсталлятор

Приложение собирается с обоими типами инсталляторов - MSI и NSIS:

```bash
npm run tauri build
```

#### Особенности инсталлятора
- **MSI Инсталлятор**: Профессиональный пакет Windows
  - Современный мастер установки
  - Интеграция с Windows "Установка и удаление программ"
  - Настройка связей файлов
  
- **NSIS Инсталлятор**: Традиционный исполняемый инсталлятор
  - Опция одноклика установки
  - Выбор директории установки
  - Ярлыки на рабочем столе и в меню "Пуск"
  - Встроенный удаляльник

#### Процесс установки
1. Пользователь загружает инсталлятор
2. Запускает инсталлятор - стандартный мастер Windows
3. Приложение устанавливается в Program Files
4. Пользователь первый раз запускает приложение
5. Автоматическая установка моделей начинается (один раз при запуске)
6. Готово к использованию!

### CI сборка релизов

Для распространения используйте CI сборку: workflow `build-release` собирает MSI/NSIS на Windows и публикует артефакты в GitHub Releases.
Запуск: тег `v*` или вручную через workflow.

### macOS бандл

Приложение собирается с:
- DMG образом для распространения
- Поддержкой автоматических обновлений
- Стандартным процессом установки macOS

### Linux AppImage

- Единый исполняемый файл
- Установка не требуется
- Модели загружаются при первом запуске
- Можно закрепить на панели задач или добавить в launcher

## Интеграция для разработчиков

### Как это работает

При запуске приложения (в `src-tauri/src/main.rs`):

1. **Init models directory** — создаёт папку для моделей в AppData
2. **Set WHISPER_MODELS_DIR env** — устанавливает переменную окружения с путём к моделям
3. **Ensure default model** — проверяет наличие модели и скачивает если нужно
4. **Initialize Whisper** — загружает модель в память

Процесс полностью асинхронный и не блокирует UI. Frontend отображает экран загрузки до завершения инициализации.

### Tauri команды

Система настройки предоставляет несколько команд для ручного управления моделями:

```typescript
// Инициализация приложения при первом запуске (вызывается автоматически)
await invoke<SetupStatus>('initialize_app')

// Получить текущий статус настройки
const status = await invoke<SetupStatus>('get_setup_status')

// Структура статуса
interface SetupStatus {
  models_initialized: boolean
  default_model_installed: boolean
  available_models: string[]
  installed_models: string[]
}

// Загрузить конкретную модель
await invoke<string>('download_model', { modelName: 'small' })

// Получить доступные модели
const models = await invoke<Array<[string, string]>>('get_available_models')
```

### React Hook

Специальный hook управляет инициализацией во frontend:

```typescript
import { useInitialization } from './hooks/useInitialization'

function MyComponent() {
  const { isInitializing, initError, setupStatus } = useInitialization()

  if (isInitializing) {
    return <div>Выполняется настройка...</div>
  }

  if (initError) {
    return <div>Ошибка: {initError}</div>
  }

  return <YourApp />
}
```

### Добавление пользовательских этапов настройки

Для добавления дополнительных этапов настройки:

1. **Модифицируйте `src-tauri/src/utils/setup.rs`**
   ```rust
   pub async fn setup_custom_feature(app_handle: &AppHandle) -> Result<(), AppError> {
       // Ваша логика настройки
   }
   ```

2. **Обновите команду инициализации в `src-tauri/src/commands/setup.rs`**
   ```rust
   pub async fn initialize_app(app_handle: tauri::AppHandle) -> Result<SetupStatus, String> {
       setup::init_models_dir(&app_handle)?;
       setup::ensure_default_model(&app_handle).await?;
       setup_custom_feature(&app_handle).await?; // Добавить здесь
       // ...
   }
   ```

3. **Обновите экран инициализации для показа прогресса** в `src/hooks/useInitialization.ts`

## Конфигурация

### Переменные окружения

Следующие переменные окружения контролируют поведение инициализации:

```bash
# Пропустить автозагрузку моделей (для разработки/офлайн)
SKIP_MODEL_DOWNLOAD=1

# Использовать пользовательскую директорию моделей (вместо AppData)
WHISPER_MODELS_DIR=/custom/path/to/models
```

**Пример**: если у вас есть `ggml-base.bin` в `/opt/whisper_models/`:

```bash
WHISPER_MODELS_DIR=/opt/whisper_models npm run tauri dev
```

## Решение проблем

### Ошибка при загрузке модели

**Симптом**: Экран инициализации зависает или показывает ошибку

**Решения**:
1. Проверьте подключение к интернету
2. Проверьте свободное место на диске (рекомендуется минимум 500MB)
3. Убедитесь, что файрвол не блокирует загрузки с HuggingFace
4. Попробуйте загрузить вручную из Настройки → Загрузить модели

### Проблемы с директорией моделей

**Симптом**: "Ошибка создания директории моделей"

**Решения**:
1. Убедитесь, что пользователь имеет права на запись в AppData
2. Проверьте доступное место на диске
3. Попробуйте запустить от администратора

### Timeout инициализации

**Симптом**: Настройка занимает более 10 минут

**Решения**:
1. Обычно это указывает на проблемы с сетью
2. Попробуйте закрыть и перезапустить приложение
3. Проверьте скорость загрузки (ожидается: 1-5 минут для модели 140MB)

## Управление моделями

### Просмотр установленных моделей

Пользователи могут просмотреть установленные модели на панели Настроек:
- Размер текущей модели
- Доступное место на диске
- Опция загрузить дополнительные модели

### Добавление новых моделей

Для поддержки дополнительных размеров модели Whisper:

1. Обновите `MODEL_URLS` в `src-tauri/src/utils/setup.rs`
2. Добавьте модель в UI панели настроек
3. Пользователи смогут загрузить из Настройки → Доступные модели

### Удаление моделей

Модели можно удалить вручную из:
```
Windows: %AppData%/voice-input-app/whisper_models/
macOS: ~/Library/Application Support/voice-input-app/whisper_models/
Linux: ~/.config/voice-input-app/whisper_models/
```

## Влияние на производительность

### Первый запуск
- **Сеть**: 2-5 минут на загрузку стандартной модели (140MB @ типичная скорость)
- **Диск**: 300MB-1GB в зависимости от установленных моделей
- **Память**: ~500MB-1GB для загрузки модели Whisper

### Последующие запуски
- **Сеть**: Нет (модели кэшированы локально)
- **Диск**: Модели остаются на диске (без пере-загрузки)
- **Память**: Такая же как при первом запуске

## Соображения безопасности

### Проверка моделей
- Модели загружаются из официального репозитория HuggingFace
- SHA256 контрольные суммы проверяются (рекомендуется для production)
- Источник надежный и широко используется

### Приватность данных
- Модели загружаются и хранятся локально
- Данные не отправляются на внешние серверы
- Вся обработка происходит на машине пользователя

### Безопасность установки
- Инсталлятор подписан сертификатом кода (рекомендуется для production)
- Не требуются повышенные привилегии для загрузки моделей
- Пользователь может вручную проверить загруженные модели

## Следующие шаги

### Для пользователей
1. Загрузите инсталлятор из релизов
2. Запустите инсталлятор
3. Запустите приложение
4. Дождитесь инициализации модели
5. Начните записывать!

### Для разработчиков
1. Ознакомьтесь с архитектурой настройки в `src-tauri/src/utils/setup.rs`
2. Добавьте пользовательские этапы настройки по необходимости
3. Протестируйте опыт первого запуска при разработке с `npm run tauri dev`
4. Мониторьте логи на предмет проблем настройки во время тестирования

### Для распространения
1. Соберите релиз: `npm run tauri build`
2. Подпишите инсталлятор (опционально, но рекомендуется)
3. Создайте примечания релиза, упомянув автоматическую настройку
4. Распространяйте через GitHub релизы, app store и т.д.

## Часто задаваемые вопросы

**В: Могут ли пользователи отключить автоматическую настройку?**
О: Нет в UI, но могут пропустить, установив переменную окружения `SKIP_INITIALIZATION=1`

**В: Могут ли модели обновляться?**
О: Пользователи должны вручную удалить старую модель и перезапустить приложение для повторной загрузки

**В: Будет ли приложение работать без интернета при первом запуске?**
О: Нет, интернет требуется для первого запуска. Последующие запуски работают оффлайн

**В: Могу ли я использовать другую реализацию Whisper?**
О: Да, модифицируйте логику загрузки модели в `setup.rs`

**В: Какой размер моделей?**
О: Tiny (39MB), Base (140MB), Small (466MB), Medium (1.5GB), Large (2.9GB)

---

Последнее обновление: 29 января 2026

