# Аудиопайплайн и обработка

Полное описание цепочки захвата, обработки и распознавания аудио.

## Оглавление

1. [Архитектура](#архитектура)
2. [Этапы обработки](#этапы-обработки)
3. [Параметры обработки](#параметры-обработки)
4. [Модули и файлы](#модули-и-файлы)
5. [Адаптивное усиление](#адаптивное-усиление)

## Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    Микрофон / Звуковое устройство           │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ↓ (16 кГц, моно, f32 [-1.0, 1.0])
┌─────────────────────────────────────────────────────────────┐
│              1. ЗАХВАТ (src-tauri/src/audio/capture.rs)      │
│  - Инициализация CPAL (Cross-Platform Audio Library)        │
│  - Автоматическое определение параметров устройства       │
│  - Выбор правильного формата: 16 кГц, моно, f32            │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ↓ (f32 образцы в буфер)
┌─────────────────────────────────────────────────────────────┐
│         2. ОБРАБОТКА (src-tauri/src/audio/processor.rs)      │
│  - Вычисление RMS входного сигнала                          │
│  - Адаптивное вычисление усиления (gain)                    │
│  - Применение noise gate (пороговое фильтрование)           │
│  - Усиление (multiplication by gain)                        │
│  - Управление размером буфера (максимум 30 сек)           │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ↓ (обработанные f32 образцы)
┌─────────────────────────────────────────────────────────────┐
│    3. ПЕРЕОТПРОБИРОВАНИЕ (src-tauri/src/recognition/whisper.rs)  │
│  - Линейная интерполяция при необходимости                  │
│  - Целевая частота: 16 кГц (обычно уже есть)               │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ↓ (16 кГц, моно, f32)
┌─────────────────────────────────────────────────────────────┐
│         4. ПАДДИНГ (src-tauri/src/recognition/whisper.rs)    │
│  - Минимальная длительность: 1.1 сек                        │
│  - Дополнение нулевыми сэмплами при необходимости          │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ↓ (готовые аудиоданные для Whisper)
┌─────────────────────────────────────────────────────────────┐
│        5. РАСПОЗНАВАНИЕ (src-tauri/src/recognition/whisper.rs)   │
│  - Whisper.cpp inference (базовая модель, 141 МБ)          │
│  - Поддержка 99 языков (включая русский)                    │
│  - Локальное распознавание (no API calls)                   │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ↓ (сырой текст с маркерами)
┌─────────────────────────────────────────────────────────────┐
│     6. ПОСТОБРАБОТКА (src-tauri/src/recognition/postprocess.rs)  │
│  - Удаление маркеров: [МУЗЫКА], [MUSIC], [АПЛОДИСМЕНТЫ]   │
│  - Удаление избыточных повторений                           │
│  - Капитализация первой буквы                               │
│  - Очистка от странных символов                             │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ↓ (чистый текст)
┌─────────────────────────────────────────────────────────────┐
│              7. ВЫВОД НА FRONTEND (Tauri event)              │
│  - recognition-completed event                               │
│  - Promise resolve в компоненте RecordButton                │
│  - Отображение в TextDisplay                                │
└─────────────────────────────────────────────────────────────┘
```

## Этапы обработки

### 1. Захват аудио

**Файл:** [`src-tauri/src/audio/capture.rs`](../src-tauri/src/audio/capture.rs)

- Использует **CPAL** (Cross-Platform Audio Library)
- Автоматически определяет параметры устройства (частоту дискретизации, каналы)
- Конвертирует различные форматы в **f32 [-1.0, 1.0]**
- **Важно:** На Windows часто используется формат **i16**, требуется правильная нормализация

**Нормализация i16 → f32:**
```rust
// Асимметричный диапазон: [-32768, 32767]
let sample_f32 = if sample_i16 < 0 {
    sample_i16 as f32 / 32768.0
} else {
    sample_i16 as f32 / 32767.0
};
```

**Частота дискретизации:** На устройстве пользователя обычно **16 кГц** (не 44.1 кГц!)

### 2. Обработка сигнала

**Файл:** [`src-tauri/src/audio/processor.rs`](../src-tauri/src/audio/processor.rs)

Применяется в реальном времени при захвате:

1. **Вычисление RMS входного сигнала**
   ```
   RMS = √(Σ(sample²) / N)
   ```
   - Нормальная речь: RMS ≈ 0.08 (целевое значение)
   - Тихая речь: RMS ≈ 0.01
   - Громкая речь: RMS ≈ 0.15

2. **Адаптивное вычисление усиления** (см. [Адаптивное усиление](#адаптивное-усиление))
   ```
   gain = target_rms / rms_input
   gain = clamp(gain, 0.5, 3.0)  // Ограничение диапазона
   ```

3. **Noise gate (пороговое фильтрование)**
   ```
   if |sample| < noise_threshold:
       sample = sample * 0.1  // Мягкий gate: 10% амплитуды
   ```

4. **Усиление и ограничение**
   ```
   sample = clamp(sample * gain, -1.0, 1.0)
   ```

5. **Управление размером буфера**
   - Максимальный размер: `sample_rate * 30 сек` = 480 000 сэмплов
   - Удаляет старые образцы, сохраняя последние 30 секунд

### 3. Переотпробирование

**Файл:** [`src-tauri/src/recognition/whisper.rs`](../src-tauri/src/recognition/whisper.rs) → `resample_linear()`

- Линейная интерполяция если частота отличается от 16 кГц
- На практике: обычно не требуется (устройство уже 16 кГц)
- Формула интерполяции:
  ```
  y = y0 + (x - x0) * (y1 - y0) / (x1 - x0)
  ```

### 4. Паддинг

**Файл:** [`src-tauri/src/recognition/whisper.rs`](../src-tauri/src/recognition/whisper.rs) → `pad_audio_min_duration()`

- Минимальная длительность для Whisper: **1.1 сек**
- Если аудио короче: добавляет нулевые сэмплы в конец

### 5. Распознавание

**Файл:** [`src-tauri/src/recognition/whisper.rs`](../src-tauri/src/recognition/whisper.rs) → `recognize()`

- Загрузка модели (первый раз, затем переиспользуется)
- Whisper inference: обработка аудиоданных моделью
- Получение текста результата

### 6. Постобработка

**Файл:** [`src-tauri/src/recognition/postprocess.rs`](../src-tauri/src/recognition/postprocess.rs)

```rust
// Удаляет маркеры типа [МУЗЫКА], [MUSIC], и т.д.
// Удаляет излишние повторения (>2х повторений подряд)
// Капитализирует первую букву
// Очищает от странных символов
fn cleanup_recognized_text(text: &str) -> String
```

## Параметры обработки

### Текущие значения

| Параметр | Значение | Описание |
|----------|----------|----------|
| **Целевой RMS** | 0.08 | Оптимальный уровень для Whisper |
| **Min gain** | 0.5 | Минимальное усиление |
| **Max gain** | 3.0 | Максимальное усиление |
| **Noise threshold** | 0.0 | Порог фильтрации (отключен) |
| **Мягкий gate** | 10% | Коэффициент для сэмплов ниже threshold |
| **Частота дискретизации** | 16 000 Гц | Стандарт для Whisper |
| **Каналы** | 1 (моно) | Моноау́дио |
| **Максимум буфер** | 30 сек | Для экономии памяти |

### Почему эти значения?

**Целевой RMS = 0.08:**
- Слишком низкий RMS: Whisper плохо распознает (нужно усиление)
- Слишком высокий RMS: обрезание сигнала, потеря качества
- 0.08 — экспериментально оптимальное значение

**Max gain = 3.0:**
- Выше 3.0: усиливаются артефакты и шумы
- Ниже 0.5: недостаточно усиления для очень тихих сигналов

**Noise threshold = 0.0 (отключен):**
- Шумовой гейт режет важные частоты речи
- Лучше обработать на постпроцессинге

## Модули и файлы

### Backend (Rust)

| Файл | Назначение |
|------|-----------|
| [`src-tauri/src/audio/capture.rs`](../src-tauri/src/audio/capture.rs) | CPAL захват, выбор формата |
| [`src-tauri/src/audio/processor.rs`](../src-tauri/src/audio/processor.rs) | Gain, noise gate, управление буфером |
| [`src-tauri/src/audio/worker.rs`](../src-tauri/src/audio/worker.rs) | Background worker для обработки |
| [`src-tauri/src/audio/formats.rs`](../src-tauri/src/audio/formats.rs) | Конвертация форматов |
| [`src-tauri/src/recognition/whisper.rs`](../src-tauri/src/recognition/whisper.rs) | Whisper inference, переотпробирование |
| [`src-tauri/src/recognition/postprocess.rs`](../src-tauri/src/recognition/postprocess.rs) | Очистка текста |
| [`src-tauri/src/types.rs`](../src-tauri/src/types.rs) | `AudioCapture` struct с параметрами |

### Frontend (React)

| Файл | Назначение |
|------|-----------|
| [`src/hooks/useRecognition.ts`](../src/hooks/useRecognition.ts) | Invoke распознавания, обработка результатов |
| [`src/hooks/useAudioStatus.ts`](../src/hooks/useAudioStatus.ts) | Состояние записи, обработки |
| [`src/components/RecordButton/useRecord.ts`](../src/components/RecordButton/useRecord.ts) | Event listeners, управление записью |
| [`src/stores/audioStore.ts`](../src/stores/audioStore.ts) | Zustand state для аудио |

## Адаптивное усиление

### Проблема

Разные микрофоны имеют разные уровни сигнала:
- Тихая речь на одном микрофоне: RMS = 0.01
- Тихая речь на другом микрофоне: RMS = 0.05

Фиксированное усиление не работает для всех случаев.

### Решение: Адаптивное RMS-based усиление

**Алгоритм:**
```
1. Каждый блок аудио (при захвате):
   - Вычисляем RMS входного сигнала
   - Если RMS > 0.001 (не полная тишина):
     gain = target_rms (0.08) / rms_input
     gain = clamp(gain, 0.5, 3.0)
   - Применяем этот gain к сэмплам

2. Результат:
   - Тихая речь (RMS 0.01) → gain = 8.0 → обрезано до 3.0 → RMS output ~0.08
   - Нормальная речь (RMS 0.08) → gain = 1.0 → RMS output = 0.08
   - Громкая речь (RMS 0.15) → gain = 0.53 → RMS output ~0.08
```

### Преимущества

✅ Автоматическая адаптация к микрофону  
✅ Не требует ручной настройки  
✅ Стабильное качество распознавания  
✅ Работает для разных громкостей  

### Реализация

**Файл:** [`src-tauri/src/audio/processor.rs`](../src-tauri/src/audio/processor.rs) → функция `process_audio()`

```rust
let target_rms = 0.08;

if rms_input > 0.001 {
    let adaptive_gain = target_rms / rms_input;
    gain = adaptive_gain.clamp(0.5, 3.0);
    
    log::info!(
        "ADAPTIVE: Input RMS {:.6} → Calculated gain: {:.2}",
        rms_input, gain
    );
}
```

---

**Смотрите также:**
- [Поток событий](event-flow.md)
- [README.md](../README.md) — Быстрый старт
- [Выбор модели Whisper](#модели-whisper) в README
